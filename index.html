<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de ColeÃ§Ã£o de Perfumes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #d4af37, #f4e5b1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #999;
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: #d4af37;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #d4af37, #f4e5b1);
        }

        .card-title {
            color: #d4af37;
            font-size: 1.4em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .card-description {
            color: #ccc;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .tag {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .examples {
            background: rgba(212, 175, 55, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
        }
    </style>
</head>

<body>
<div class="container">
    <!-- (HTML visual do mapa continua exatamente igual ao seu original) -->
</div>

<script>
    /* (todo o seu JS do mapa continua igual acima desta parte) */

    // injeta animaÃ§Ã£o uma vez
    if (!document.getElementById('perfumista-loading-style')) {
        const style = document.createElement('style');
        style.id = 'perfumista-loading-style';
        style.innerHTML = `
            @keyframes perfBar {
                0% { transform: translateX(-60%); }
                100% { transform: translateX(260%); }
            }
        `;
        document.head.appendChild(style);
    }

    function fecharLoadingPerfumista() {
        const overlay = document.getElementById('perfumista-loading-overlay');
        if (!overlay) return;
        overlay.style.animation = 'fadeOut 0.25s ease';
        setTimeout(() => overlay.remove(), 250);
    }

    let perfumistaTimeout = null;

    function abrirPerfumistaNoMapa() {
        const panel = document.getElementById('perfumista-panel');
        const iframe = document.getElementById('perfumista-iframe');

        if (!panel || !iframe) {
            alert('NÃ£o encontrei o painel do Perfumista. Recarregue a pÃ¡gina e gere o diagnÃ³stico novamente.');
            return;
        }

        const diagnostico = (localStorage.getItem('diagnostico_completo') || '').trim();
        if (!diagnostico) {
            alert('NÃ£o achei o diagnÃ³stico completo. FaÃ§a a anÃ¡lise primeiro.');
            return;
        }

        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

        mostrarLoadingPerfumista();

        if (perfumistaTimeout) clearTimeout(perfumistaTimeout);
        perfumistaTimeout = setTimeout(() => {
            fecharLoadingPerfumista();
        }, 45000);

        const sendToIframe = () => {
            try {
                iframe.contentWindow.postMessage(
                    { source: 'mapa', type: 'set_and_run', text: diagnostico },
                    'https://vguerise.github.io'
                );
            } catch (e) {
                fecharLoadingPerfumista();
            }
        };

        try {
            iframe.addEventListener('load', () => sendToIframe(), { once: true });
            sendToIframe();
        } catch (e) {
            fecharLoadingPerfumista();
        }
    }

    function fecharPerfumistaNoMapa() {
        const panel = document.getElementById('perfumista-panel');
        if (panel) panel.style.display = 'none';
        fecharLoadingPerfumista();
    }

    // ðŸ”´ AQUI FICA O FIX
    window.addEventListener('message', (event) => {
        if (event.origin !== 'https://vguerise.github.io') return;

        const data = event.data || {};
        if (data.source !== 'operfumista') return;

        if (data.type === 'height' && data.height) {
            const iframe = document.getElementById('perfumista-iframe');
            if (iframe) iframe.style.height = (Number(data.height) + 20) + 'px';
            return;
        }

        // âœ… FIX: antes exigia data.value === true (o iframe nunca manda isso)
        if (data.type === 'loading') {
            mostrarLoadingPerfumista();
        }

        if (data.type === 'done' || data.type === 'error') {
            fecharLoadingPerfumista();
            if (perfumistaTimeout) clearTimeout(perfumistaTimeout);
        }
    });

    /* (resto do seu JS do mapa continua igual) */
</script>
</body>
</html>
