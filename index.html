<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa da Cole√ß√£o Perfeita</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#1e1e1e 0%,#2d2d2d 100%);
      padding:20px;
      min-height:100vh;
    }
    .container{max-width:1400px;margin:0 auto}
    header{text-align:center;color:white;margin-bottom:40px}
    h1{
      font-size:2.5em;margin-bottom:10px;
      background:linear-gradient(90deg,#d4af37,#f4e5b1);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .subtitle{color:#999;font-size:1.1em}
    .section-title{
      color:white;font-size:1.8em;margin:40px 0 20px 0;text-align:center;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:20px;
      margin-bottom:40px;
    }
    .card{
      background:rgba(255,255,255,0.05);
      border:2px solid rgba(212,175,55,0.3);
      border-radius:15px;
      padding:25px;
      transition:all 0.3s ease;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .card:hover{
      transform:translateY(-5px);
      border-color:#d4af37;
      box-shadow:0 10px 30px rgba(212,175,55,0.3);
    }
    .card::before{
      content:'';
      position:absolute;top:0;left:0;width:100%;height:5px;
      background:linear-gradient(90deg,#d4af37,#f4e5b1);
    }
    .card-title{color:#d4af37;font-size:1.4em;margin-bottom:15px;font-weight:600}
    .card-description{color:#ccc;font-size:0.95em;line-height:1.6;margin-bottom:15px}
    .card-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:15px}
    .tag{
      background:rgba(212,175,55,0.2);
      color:#d4af37;
      padding:5px 12px;
      border-radius:20px;
      font-size:0.85em;
      border:1px solid rgba(212,175,55,0.3);
    }
    .examples{
      background:rgba(212,175,55,0.1);
      padding:12px;
      border-radius:8px;
      margin-top:15px;
    }
    .examples-title{color:#d4af37;font-size:0.9em;font-weight:600;margin-bottom:8px}
    .examples-list{color:#aaa;font-size:0.85em;line-height:1.5}
    .checkbox-container{
      display:flex;align-items:center;gap:10px;margin-top:10px;
      padding:15px;
      background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(212,175,55,0.05));
      border:2px solid rgba(212,175,55,0.4);
      border-radius:8px;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .checkbox-container:hover{
      background:linear-gradient(135deg,rgba(212,175,55,0.25),rgba(212,175,55,0.1));
    }
    .checkbox-container input{transform:scale(1.2);cursor:pointer}
    .checkbox-container label{color:#fff;font-size:1.05em;font-weight:600;cursor:pointer}

    .balance-section{display:flex;justify-content:center;margin-top:30px}
    .balance-card{
      background:rgba(255,255,255,0.05);
      border:2px solid rgba(212,175,55,0.3);
      border-radius:15px;
      padding:40px;
      max-width:900px;
      width:100%;
    }
    .balance-title{color:#d4af37;font-size:1.8em;margin-bottom:10px;text-align:center}
    .balance-description{color:#ccc;text-align:center;margin-bottom:22px;line-height:1.6}
    .context-section{
      margin:20px 0 18px 0;
      padding:18px;
      border-radius:12px;
      background:linear-gradient(135deg,rgba(100,150,255,0.12),rgba(100,150,255,0.04));
      border:2px solid rgba(100,150,255,0.25);
    }
    .context-title{color:#9bc4ff;font-weight:800;margin-bottom:12px;letter-spacing:0.5px}
    textarea.colecao{
      width:100%;
      min-height:140px;
      margin-top:10px;
      background:rgba(0,0,0,0.35);
      color:#fff;
      border:2px solid rgba(212,175,55,0.25);
      border-radius:10px;
      padding:12px;
      font-size:1em;
      line-height:1.5;
      outline:none;
      transition:all 0.25s ease;
      resize:vertical;
    }
    textarea.colecao:focus{border-color:#d4af37;box-shadow:0 0 0 3px rgba(212,175,55,0.15)}
    .helper{color:#9c9c9c;font-size:0.9em;margin-top:8px;line-height:1.5}

    .analyze-btn{
      width:100%;
      padding:15px;
      font-size:1.2em;
      font-weight:700;
      background:linear-gradient(90deg,#d4af37,#f4e5b1);
      color:#1e1e1e;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      margin-top:18px;
    }
    .analyze-btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(212,175,55,0.4)}
    .result-box{
      margin-top:30px;
      background:rgba(212,175,55,0.1);
      border:2px solid rgba(212,175,55,0.25);
      border-radius:12px;
      padding:22px;
    }
    .result-title{color:#d4af37;font-size:1.35em;font-weight:900;margin-bottom:14px;text-align:center}
    .result-content{color:#fff;line-height:1.65}
    .result-advice{color:#ccc;margin-top:12px;line-height:1.7}
    .result-next{margin-top:18px}

    .interactive-note{
      background:rgba(100,150,255,0.1);
      border:2px solid rgba(100,150,255,0.3);
      border-radius:10px;
      padding:20px;
      margin-top:40px;
      text-align:center;
      color:#9bc4ff;
    }

    @media (max-width: 1024px){
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width: 768px){
      h1{font-size:1.85em}
      .grid{grid-template-columns:1fr}
      .balance-card{padding:26px}
    }
  

    /* ==============================
       Cole√ß√£o (Adicionar + Modal)
       ============================== */
    .colecao-add-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .colecao-input{
      flex:1 1 320px;
      min-width:260px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
    }
    .colecao-input:focus{border-color:rgba(155,196,255,.55)}
    .mini-btn{
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(155,196,255,.35);
      background:rgba(14,38,78,.55);
      color:#eaf2ff;
      font-weight:800;
      cursor:pointer;
      transition:transform .08s ease, filter .2s ease;
      white-space:nowrap;
    }
    .mini-btn:hover{filter:brightness(1.1)}
    .mini-btn:active{transform:scale(.98)}
    .mini-btn.secondary{
      background:rgba(0,0,0,.20);
      border-color:rgba(255,255,255,.16);
      color:#e8eefc;
      font-weight:700;
    }

    /* Modal */
    .modal{position:fixed;inset:0;display:none;z-index:9999}
    .modal.show{display:block}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .modal-card{
      position:relative;
      width:min(720px, calc(100% - 28px));
      margin:70px auto 0;
      background:rgba(10,18,35,.96);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10)}
    .modal-title{font-weight:900;color:#eaf2ff;letter-spacing:.2px}
    .modal-close{
      width:36px;height:36px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#eaf2ff;
      cursor:pointer;
      font-weight:900;
    }
    .modal-close:hover{filter:brightness(1.1)}
    .modal-body{padding:14px 16px}
    .modal-sub{color:rgba(255,255,255,.72);margin-bottom:10px}
    .colecao-pre{
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 14px;
      color:#fff;
      max-height:320px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.5;
    }
    .modal-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,.10);display:flex;justify-content:flex-end;gap:10px}
</style>
</head>

<body>
  <div class="container">
    <header>
      <h1>MAPA DA COLE√á√ÉO PERFEITA</h1>
      <p class="subtitle">Sem redund√¢ncia. Cada perfume com fun√ß√£o real.</p>
    </header>

    <h2 class="section-title">AS 6 FUN√á√ïES ESSENCIAIS</h2>

    <div class="grid">
      <div class="card">
        <div class="card-title">üåû CALOR</div>
        <div class="card-description">
          Perfume leve, fresco e que n√£o sufoca. Alta temperatura exige baixa densidade.
        </div>
        <div class="card-tags">
          <span class="tag">C√≠trico</span><span class="tag">Aqu√°tico</span><span class="tag">Verde</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ C√≠trico + aqu√°tico<br>‚Ä¢ Verde fresco<br>‚Ä¢ Arom√°tico leve</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="calor" />
          <label for="calor">Tenho um perfume para calor</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚ùÑÔ∏è FRIO</div>
        <div class="card-description">
          Perfume denso, quente e envolvente. Baixa temperatura pede mais corpo e presen√ßa.
        </div>
        <div class="card-tags">
          <span class="tag">√Çmbar</span><span class="tag">Madeira</span><span class="tag">Especiaria</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ √Çmbar + baunilha<br>‚Ä¢ Madeira seca + especiaria<br>‚Ä¢ Oriental denso</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="frio" />
          <label for="frio">Tenho um perfume para frio</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üíº TRABALHO</div>
        <div class="card-description">
          Discreto, profissional, baixo risco. Passa batido at√© ser notado de perto.
        </div>
        <div class="card-tags">
          <span class="tag">Arom√°tico</span><span class="tag">Amadeirado seco</span><span class="tag">Fresco discreto</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ Arom√°tico limpo<br>‚Ä¢ Amadeirado elegante<br>‚Ä¢ Fresco-seco balanceado</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="trabalho" />
          <label for="trabalho">Tenho um perfume para trabalho</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üåô NOITE</div>
        <div class="card-description">
          Marcante e de presen√ßa. Aqui voc√™ pode ousar (desde que fa√ßa sentido pra voc√™).
        </div>
        <div class="card-tags">
          <span class="tag">Doce denso</span><span class="tag">Couro</span><span class="tag">Oriental intenso</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ Doce + especiaria<br>‚Ä¢ Couro + fuma√ßa<br>‚Ä¢ √Çmbar + oud</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="noite" />
          <label for="noite">Tenho um perfume para noite</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚úçÔ∏è ASSINATURA</div>
        <div class="card-description">
          Seu perfume identidade. Vers√°til, confort√°vel e voc√™ ama usar.
        </div>
        <div class="card-tags">
          <span class="tag">Pessoal</span><span class="tag">Vers√°til</span><span class="tag">Confort√°vel</span>
        </div>
        <div class="examples">
          <div class="examples-title">Caracter√≠sticas:</div>
          <div class="examples-list">‚Ä¢ Funciona em v√°rias situa√ß√µes<br>‚Ä¢ Voc√™ n√£o cansa dele<br>‚Ä¢ As pessoas te associam a ele</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="assinatura" />
          <label for="assinatura">Tenho meu perfume assinatura</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üéä OCASI√ïES ESPECIAIS</div>
        <div class="card-description">
          Para casamentos, eventos, festas e momentos memor√°veis.
        </div>
        <div class="card-tags">
          <span class="tag">Festivo</span><span class="tag">Marcante</span><span class="tag">Especial</span>
        </div>
        <div class="examples">
          <div class="examples-title">Ocasi√µes ideais:</div>
          <div class="examples-list">‚Ä¢ Casamentos e formaturas<br>‚Ä¢ Festas e celebra√ß√µes<br>‚Ä¢ Jantares e eventos</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="ocasioes" />
          <label for="ocasioes">Tenho perfume para ocasi√µes especiais</label>
        </div>
      </div>
    </div>

    <h2 class="section-title">üéØ DIAGN√ìSTICO + TOP 3 COM I.A.</h2>

    <div class="balance-section">
      <div class="balance-card">
        <div class="balance-title">Cole sua cole√ß√£o (fica salva no seu navegador)</div>
        <div class="balance-description">
          Sem base de dados aqui no mapa. Voc√™ coloca a sua lista, escolhe o contexto, e o Perfumista sugere s√≥ o Top 3 no iframe.
        </div>

        <div class="context-section">
          <div class="context-title">üìç Contexto</div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:22px;">
            <div style="display:flex;flex-direction:column;gap:14px;">
              <div>
                <label style="margin-bottom:10px;display:block;color:#9bc4ff;font-weight:600;">üíº Ambiente de trabalho</label>
                <select id="ambiente" style="width:100%;padding:12px 15px;font-size:1em;background:rgba(0,0,0,0.3);border:2px solid rgba(100,150,255,0.3);border-radius:8px;color:white;cursor:pointer;transition:all 0.3s ease;"
                  onfocus="this.style.borderColor='#9bc4ff'" onblur="this.style.borderColor='rgba(100,150,255,0.3)'">
                  <option value="" selected disabled>Selecione</option>
                  <option value="fechado">Fechado (escrit√≥rio, loja)</option>
                  <option value="aberto">Aberto (obra, rua, campo)</option>
                  <option value="ambos">Ambos</option>
                </select>
              </div>

              <div>
                <label style="margin-bottom:10px;display:block;color:#9bc4ff;font-weight:600;">üí∞ Or√ßamento</label>
                <select id="orcamento" style="width:100%;padding:12px 15px;font-size:1em;background:rgba(0,0,0,0.3);border:2px solid rgba(100,150,255,0.3);border-radius:8px;color:white;cursor:pointer;transition:all 0.3s ease;"
                  onfocus="this.style.borderColor='#9bc4ff'" onblur="this.style.borderColor='rgba(100,150,255,0.3)'">
                  <option value="" selected disabled>Selecione</option>
                  <option value="ate-350">At√© R$ 350</option>
                  <option value="350-1500">R$ 350 - R$ 1.500</option>
                  <option value="1500-2500">R$ 1.500 - R$ 2.500</option>
                  <option value="sem-limite">Sem limite</option>
                </select>
              </div>
            </div>

            <div>
              <label style="margin-bottom:10px;display:block;color:#9bc4ff;font-weight:600;">üå°Ô∏è Clima da sua regi√£o</label>
              <input type="hidden" id="clima" value="temperado" />
              <div style="display:flex;gap:10px;margin-top:10px;">
                <button type="button" onclick="selecionarClima('quente', this)" class="clima-btn"
                  style="flex:1;padding:15px 10px;background:rgba(255,100,100,0.1);border:2px solid rgba(255,100,100,0.3);color:white;border-radius:10px;cursor:pointer;font-size:0.95em;transition:all 0.3s;text-align:center;">
                  <div style="font-size:1.5em;margin-bottom:5px;">‚òÄÔ∏è</div>
                  <div style="font-weight:600;">Quente</div>
                  <div style="font-size:0.75em;color:#888;margin-top:3px;">Norte, Nordeste</div>
                </button>

                <button type="button" onclick="selecionarClima('temperado', this)" class="clima-btn"
                  style="flex:1;padding:15px 10px;background:rgba(212,175,55,0.3);border:2px solid #d4af37;color:white;border-radius:10px;cursor:pointer;font-size:0.95em;transition:all 0.3s;text-align:center;box-shadow:0 0 20px rgba(212,175,55,0.5);">
                  <div style="font-size:1.5em;margin-bottom:5px;">üå§Ô∏è</div>
                  <div style="font-weight:600;">Temperado</div>
                  <div style="font-size:0.75em;color:#888;margin-top:3px;">Sudeste</div>
                </button>

                <button type="button" onclick="selecionarClima('frio', this)" class="clima-btn"
                  style="flex:1;padding:15px 10px;background:rgba(150,200,255,0.1);border:2px solid rgba(150,200,255,0.3);color:white;border-radius:10px;cursor:pointer;font-size:0.95em;transition:all 0.3s;text-align:center;">
                  <div style="font-size:1.5em;margin-bottom:5px;">‚ùÑÔ∏è</div>
                  <div style="font-weight:600;">Frio</div>
                  <div style="font-size:0.75em;color:#888;margin-top:3px;">Sul</div>
                </button>
              </div>
            </div>
          </div>

          
          <div style="margin-top:18px;">
            <label style="display:block;color:#9bc4ff;font-weight:700;margin-bottom:8px;">üßæ Sua cole√ß√£o</label>

            <div class="colecao-add-row">
              <input id="perfumeInput" class="colecao-input" type="text" placeholder="Digite o nome do perfume e clique em Adicionar" autocomplete="off" />
              <button class="mini-btn" type="button" onclick="addPerfume()">Adicionar</button>
              <button class="mini-btn secondary" type="button" onclick="openColecaoModal()">Ver cole√ß√£o completa (<span id="colecaoCount">0</span>)</button>
            </div>

            <div class="helper">
              ‚Ä¢ Isso fica salvo no seu navegador (localStorage).<br>
              ‚Ä¢ Ao adicionar, o nome √© padronizado na exibi√ß√£o (Primeira Letra Mai√∫scula).<br>
              ‚Ä¢ Se voc√™ n√£o preencher, o Perfumista vai trabalhar s√≥ com as 6 fun√ß√µes e o contexto ‚Äî fica pior.
            </div>
          </div>

          <!-- Modal: Cole√ß√£o completa -->
          <div id="colecaoModal" class="modal" aria-hidden="true">
            <div class="modal-backdrop" onclick="closeColecaoModal()"></div>
            <div class="modal-card" role="dialog" aria-modal="true" aria-label="Cole√ß√£o completa">
              <div class="modal-header">
                <div class="modal-title">üìö Cole√ß√£o completa</div>
                <button class="modal-close" type="button" onclick="closeColecaoModal()">‚úï</button>
              </div>
              <div class="modal-body">
                <div class="modal-sub">
                  <span>Total:</span> <strong><span id="colecaoTotalModal">0</span></strong>
                </div>
                <pre id="colecaoList" class="colecao-pre">(vazio)</pre>
              </div>
              <div class="modal-footer">
                <button class="mini-btn secondary" type="button" onclick="closeColecaoModal()">Fechar</button>
              </div>
            </div>
          </div>

        </div>

        <button class="analyze-btn" onclick="analyzeCollection()">ANALISAR COLE√á√ÉO</button>

        <div id="result" class="result-box" style="display:none;">
          <div class="result-title">üìä RESULTADO DA AN√ÅLISE</div>
          <div id="dominant-family" class="result-content"></div>
          <div id="balance-advice" class="result-advice"></div>
          <div id="next-purchase" class="result-next"></div>
        </div>
      </div>
    </div>

    <div class="interactive-note">
      <h3 style="margin-bottom:15px;">üìã COMO USAR</h3>
      <p style="line-height:1.8;">
        1) Marque as 6 fun√ß√µes que voc√™ j√° cobre<br>
        2) Cole sua lista de perfumes (um por linha)<br>
        3) Clique em ‚ÄúAnalisar‚Äù<br>
        4) Gere o Top 3 no Perfumista dentro do iframe
      </p>
    </div>
  </div>

  <script>
    // ==============================
    // Persist√™ncia (localStorage)
    // ==============================
    const LS_KEYS = {
      clima: "clima",
      ambiente: "ambiente",
      orcamento: "orcamento",
      colecao: "colecao_lista",
      diagnostico: "diagnostico_completo",
    };

    function safeSet(key, value){
      try{ localStorage.setItem(key, value); }catch(e){}
    }
    function safeGet(key){
      try{ return localStorage.getItem(key); }catch(e){ return null; }
    }

    // ==============================
    // Clima (bot√µes)
    // ==============================
    function selecionarClima(clima, btn){
      document.querySelectorAll(".clima-btn").forEach(function(b){
        b.classList.remove("selected-quente");
        b.classList.remove("selected-temperado");
        b.classList.remove("selected-frio");
      });
      btn.classList.add("selected-" + clima);
      document.getElementById("clima").value = clima;
      safeSet(LS_KEYS.clima, clima);
    }

    // ==============================
    // Checkboxes: salvar / carregar
    // ==============================
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox){
      checkbox.addEventListener("change", function(){
        safeSet(this.id, this.checked ? "true" : "false");
      });
      const saved = safeGet(checkbox.id);
      if(saved === "true"){ checkbox.checked = true; }
    });

    // ==============================
    // Contexto: salvar / carregar
    // ==============================
    function attachPersistSelect(id, key){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener("change", function(){
        safeSet(key, this.value);
      });
      const saved = safeGet(key);
      if(saved){ el.value = saved; }
    }
    attachPersistSelect("ambiente", LS_KEYS.ambiente);
    attachPersistSelect("orcamento", LS_KEYS.orcamento);

    

    // ==============================
    // Cole√ß√£o: adicionar / listar (localStorage)
    // ==============================
    function loadCollection(){
      try{
        const raw = safeGet(LS_KEYS.colecao);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      }catch(e){
        return [];
      }
    }
    function saveCollection(arr){
      safeSet(LS_KEYS.colecao, JSON.stringify(arr || []));
    }

    // Title Case com exce√ß√µes (n√£o destr√≥i siglas curtas)
    function toTitleCaseSmart(input){
      const s = String(input || "").trim().replace(/\s+/g, " ");
      if(!s) return "";
      const lowerWords = new Set(["de","da","do","das","dos","e"]);
      const words = s.split(" ");
      return words.map(function(w, idx){
        if(!w) return "";
        // mant√©m palavras com n√∫meros/s√≠mbolos como est√£o
        if(/[0-9]/.test(w)) return w;
        // mant√©m siglas curtas (EDT/EDP/etc em caps)
        if(w === w.toUpperCase() && w.length <= 4) return w;
        const wl = w.toLowerCase();
        if(idx !== 0 && lowerWords.has(wl)) return wl;
        return wl.charAt(0).toUpperCase() + wl.slice(1);
      }).join(" ");
    }

    function updateColecaoCount(){
      const arr = loadCollection();
      const el = document.getElementById("colecaoCount");
      if(el) el.textContent = String(arr.length);
    }

    function addPerfume(){
      const input = document.getElementById("perfumeInput");
      if(!input) return;
      const raw = (input.value || "").trim();
      if(!raw) return;

      const formatted = toTitleCaseSmart(raw);
      const arr = loadCollection();
      arr.push(formatted);
      saveCollection(arr);

      input.value = "";
      updateColecaoCount();
    }

    function openColecaoModal(){
      const modal = document.getElementById("colecaoModal");
      const pre = document.getElementById("colecaoList");
      const totalEl = document.getElementById("colecaoTotalModal");
      const arr = loadCollection();

      if(totalEl) totalEl.textContent = String(arr.length);
      if(pre){
        pre.textContent = arr.length ? arr.join("\n") : "(vazio)";
      }
      if(modal){
        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
      }
    }

    function closeColecaoModal(){
      const modal = document.getElementById("colecaoModal");
      if(modal){
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
      }
    }

    // Inicializa√ß√£o
    (function initColecaoUI(){
      updateColecaoCount();
      const input = document.getElementById("perfumeInput");
      if(input){
        // Enter adiciona
        input.addEventListener("keydown", function(ev){
          if(ev.key === "Enter"){
            ev.preventDefault();
            addPerfume();
          }
        });
      }
    })();

);
      const savedColecao = safeGet(LS_KEYS.colecao);
      if(savedColecao){ colecaoEl.value = savedColecao; }
    }

    // Carregar clima salvo (e refletir visualmente)
    (function(){
      const savedClima = safeGet(LS_KEYS.clima) || "temperado";
      document.getElementById("clima").value = savedClima;
      const btns = document.querySelectorAll(".clima-btn");
      if(btns && btns.length){
        const map = { quente: 0, temperado: 1, frio: 2 };
        const idx = map[savedClima] ?? 1;
        btns.forEach(b=>b.style.boxShadow="none");
        // re-dispara sele√ß√£o para setar class + storage
        try{ selecionarClima(savedClima, btns[idx]); }catch(e){}
      }
    })();

    // ==============================
    // Painel Perfumista (iframe)
    // ==============================
    function mostrarLoadingPerfumista(){
      const existing = document.getElementById("perfumista-loading-overlay");
      if(existing) return;

      const overlay = document.createElement("div");
      overlay.id = "perfumista-loading-overlay";
      overlay.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index: 9999;
        animation: fadeIn 0.25s ease;
      `;

      overlay.innerHTML = `
        <div style="
          width:min(520px,92vw);
          background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
          border: 2px solid #d4af37;
          border-radius: 18px;
          padding: 26px;
          box-shadow: 0 20px 60px rgba(212,175,55,0.25);
        ">
          <div style="color:#d4af37;font-weight:900;font-size:1.1em;letter-spacing:1px;text-align:center;">
            CONSULTANDO O PERFUMISTA
          </div>
          <div style="color:#ccc;text-align:center;margin-top:10px;line-height:1.6;">
            A resposta vai aparecer dentro do iframe.<br/>
            N√£o feche a p√°gina.
          </div>
          <div style="margin-top:16px;height:10px;border-radius:999px;overflow:hidden;background: rgba(212,175,55,0.15);">
            <div style="height:100%;width:40%;background: linear-gradient(90deg,#d4af37,#f4e5b1);animation: perfBar 1.1s infinite ease-in-out;"></div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      if(!document.getElementById("perfumista-loading-style")){
        const style = document.createElement("style");
        style.id = "perfumista-loading-style";
        style.innerHTML = `
          @keyframes perfBar { 0%{transform:translateX(-60%)} 100%{transform:translateX(260%)} }
          @keyframes fadeIn { from{opacity:0} to{opacity:1} }
          @keyframes fadeOut { from{opacity:1} to{opacity:0} }
        `;
        document.head.appendChild(style);
      }
    }

    function fecharLoadingPerfumista(){
      const overlay = document.getElementById("perfumista-loading-overlay");
      if(!overlay) return;
      overlay.style.animation = "fadeOut 0.25s ease";
      setTimeout(()=>{ try{ overlay.remove(); }catch(e){} }, 250);
    }

    let perfumistaTimeout = null;

    function abrirPerfumistaNoMapa(){
      const panel = document.getElementById("perfumista-panel");
      const iframe = document.getElementById("perfumista-iframe");
      if(!panel || !iframe){
        alert("N√£o encontrei o painel do Perfumista. Recarregue a p√°gina e analise novamente.");
        return;
      }

      const diagnostico = (safeGet(LS_KEYS.diagnostico) || "").trim();
      if(!diagnostico){
        alert("N√£o achei o diagn√≥stico completo. Clique em ANALISAR COLE√á√ÉO primeiro.");
        return;
      }

      panel.style.display = "block";
      panel.scrollIntoView({ behavior:"smooth", block:"start" });

      mostrarLoadingPerfumista();

      if(perfumistaTimeout) clearTimeout(perfumistaTimeout);
      perfumistaTimeout = setTimeout(()=>{ fecharLoadingPerfumista(); }, 45000);

      const sendToIframe = () => {
        try{
          iframe.contentWindow.postMessage(
            { source:"mapa", type:"set_and_run", text: diagnostico },
            "https://vguerise.github.io"
          );
        }catch(e){
          fecharLoadingPerfumista();
        }
      };

      try{
        iframe.addEventListener("load", ()=>sendToIframe(), { once:true });
        sendToIframe();
      }catch(e){
        fecharLoadingPerfumista();
      }
    }

    function fecharPerfumistaNoMapa(){
      const panel = document.getElementById("perfumista-panel");
      if(panel) panel.style.display = "none";
      fecharLoadingPerfumista();
    }

    // Recebe status do iframe (Perfumista)
    window.addEventListener("message", (event)=>{
      if(event.origin !== "https://vguerise.github.io") return;
      const data = event.data || {};
      if(data.source !== "operfumista") return;

      if(data.type === "height" && data.height){
        const iframe = document.getElementById("perfumista-iframe");
        if(iframe) iframe.style.height = (Number(data.height) + 20) + "px";
        return;
      }
      if(data.type === "loading"){ mostrarLoadingPerfumista(); }
      if(data.type === "done" || data.type === "error"){
        fecharLoadingPerfumista();
        if(perfumistaTimeout) clearTimeout(perfumistaTimeout);
      }
    });

    window.abrirPerfumistaNoMapa = abrirPerfumistaNoMapa;
    window.fecharPerfumistaNoMapa = fecharPerfumistaNoMapa;

    // ==============================
    // An√°lise (sem fam√≠lias no mapa)
    // ==============================
    function getChecked(){
      const ids = ["calor","frio","trabalho","noite","assinatura","ocasioes"];
      const labels = {
        calor: "üåû Calor",
        frio: "‚ùÑÔ∏è Frio",
        trabalho: "üíº Trabalho",
        noite: "üåô Noite",
        assinatura: "‚úçÔ∏è Assinatura",
        ocasioes: "üéä Ocasi√µes especiais",
      };
      const checked = [];
      const missing = [];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el && el.checked) checked.push(labels[id]);
        else missing.push(labels[id]);
      });
      return { checked, missing, total: ids.length };
    }

    function countPerfumesFromText(text){
      const lines = (text || "")
        .split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean);
      return { total: lines.length, lines };
    }

    function calcLevel(total){
      if(total <= 0) return { emoji:"üß™", label:"SEM LISTA", advice:"Cole sua lista de perfumes para o diagn√≥stico ficar minimamente confi√°vel." };
      if(total >= 1 && total <= 5) return { emoji:"üéØ", label:"INICIANTE", advice:"Antes de comprar mais, garanta as 6 fun√ß√µes. Evite redund√¢ncia cedo." };
      if(total >= 6 && total <= 10) return { emoji:"üìà", label:"INTERMEDI√ÅRIO", advice:"Agora o jogo √©: reduzir sobreposi√ß√£o e cobrir subfun√ß√µes (trabalho fechado vs aberto, calor extremo, etc.)." };
      if(total >= 11 && total <= 15) return { emoji:"üî•", label:"AVAN√áADO", advice:"Cole√ß√£o j√° d√° pra ser cir√∫rgico. Cada compra precisa de fun√ß√£o clara e lacuna real." };
      return { emoji:"üëë", label:"COLECIONADOR", advice:"Se n√£o tem fun√ß√£o clara, √© ac√∫mulo. Venda/troque o redundante antes de comprar." };
    }

    function labelOrcamento(v){
      const map = {
        "ate-350": "At√© R$ 350",
        "350-1500": "R$ 350 - R$ 1.500",
        "1500-2500": "R$ 1.500 - R$ 2.500",
        "sem-limite": "Sem limite",
      };
      return map[v] || "N√£o informado";
    }

    function labelAmbiente(v){
      const map = {
        "fechado": "Fechado (escrit√≥rio/loja)",
        "aberto": "Aberto (rua/obra/campo)",
        "ambos": "Ambos",
      };
      return map[v] || "N√£o informado";
    }

    function analyzeCollection(){
      const clima = (document.getElementById("clima").value || "temperado").trim();
      const ambiente = (document.getElementById("ambiente").value || "").trim();
      const orcamento = (document.getElementById("orcamento").value || "").trim();
      const colecaoArr = loadCollection();
      const colecaoTxt = (colecaoArr || []).join("
").trim();
safeSet(LS_KEYS.clima, clima);
      if(ambiente) safeSet(LS_KEYS.ambiente, ambiente);
      if(orcamento) safeSet(LS_KEYS.orcamento, orcamento);
      const totalPerfumes = (colecaoArr || []).length;
      const lines = (colecaoArr || []);
const { checked, missing, total: totalFuncoes } = getChecked();

      const level = calcLevel(totalPerfumes);
      const cobertura = Math.round((checked.length / totalFuncoes) * 100);

      // Montar diagn√≥stico pro agente (iframe)
      let diagnostico = "";
      diagnostico += "Ol√°! Acabei de fazer meu diagn√≥stico de cole√ß√£o de perfumes e preciso de ajuda.\n\n";
      diagnostico += "üìä MEU PERFIL:\n";
      diagnostico += "‚Ä¢ Total de perfumes: " + totalPerfumes + "\n";
      diagnostico += "‚Ä¢ N√≠vel: " + level.label + "\n";
      diagnostico += "‚Ä¢ Clima: " + clima + "\n";
      diagnostico += "‚Ä¢ Or√ßamento: " + labelOrcamento(orcamento) + "\n";
      diagnostico += "‚Ä¢ Ambiente de trabalho: " + labelAmbiente(ambiente) + "\n\n";

      diagnostico += "üßæ MINHA COLE√á√ÉO (lista):\n";
      if(lines.length){
        diagnostico += lines.map(p => "‚Ä¢ " + p).join("\n") + "\n\n";
      }else{
        diagnostico += "‚Ä¢ (n√£o informada)\n\n";
      }

      diagnostico += "üß≠ FUN√á√ïES COBERTAS NO MAPA:\n";
      diagnostico += "‚Ä¢ Cobertas: " + (checked.length ? checked.join(", ") : "Nenhuma") + "\n";
      diagnostico += "‚Ä¢ Descobertas: " + (missing.length ? missing.join(", ") : "Nenhuma") + "\n\n";

      diagnostico += "üéØ O QUE PRECISO:\n";
      diagnostico += "Me d√™ APENAS 3 sugest√µes (Top 3) dispon√≠veis no Brasil.\n";
      diagnostico += "Priorize fam√≠lias olfativas menos representadas na minha cole√ß√£o e que fa√ßam sentido para clima, or√ßamento e ambiente.\n";
      diagnostico += "Evite redund√¢ncias √≥bvias com o que eu j√° tenho.";

      safeSet(LS_KEYS.diagnostico, diagnostico);

      // Render na tela
      const resultDiv = document.getElementById("result");
      const dominantDiv = document.getElementById("dominant-family");
      const adviceDiv = document.getElementById("balance-advice");
      const nextDiv = document.getElementById("next-purchase");

      const climaLabel = clima === "quente" ? "üå°Ô∏è Clima quente" : clima === "frio" ? "‚ùÑÔ∏è Clima frio" : "üå§Ô∏è Clima temperado";

      dominantDiv.innerHTML = `
        <div style="background: rgba(212,175,55,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #d4af37;">
          <div style="font-size: 1.25em; margin-bottom: 8px;">${level.emoji} <strong>SEU N√çVEL: ${level.label}</strong></div>
          <div style="color:#ccc; font-size: 0.95em;">${level.advice}</div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px;">
          <div style="background: linear-gradient(135deg, rgba(100, 150, 255, 0.15), rgba(100, 150, 255, 0.05)); border: 2px solid rgba(100, 150, 255, 0.4); border-radius: 8px; padding: 12px;">
            <div style="font-size: 0.85em; color: #9bc4ff; margin-bottom: 6px; font-weight: 600;">üå°Ô∏è CLIMA</div>
            <div style="color:#fff;font-size:0.98em;">${climaLabel}</div>
          </div>

          <div style="background: linear-gradient(135deg, rgba(100, 150, 255, 0.15), rgba(100, 150, 255, 0.05)); border: 2px solid rgba(100, 150, 255, 0.4); border-radius: 8px; padding: 12px;">
            <div style="font-size: 0.85em; color: #9bc4ff; margin-bottom: 6px; font-weight: 600;">üíº AMBIENTE</div>
            <div style="color:#fff;font-size:0.98em;">${labelAmbiente(ambiente)}</div>
          </div>

          <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05)); border: 2px solid rgba(212, 175, 55, 0.4); border-radius: 8px; padding: 12px;">
            <div style="font-size: 0.85em; color: #d4af37; margin-bottom: 6px; font-weight: 600;">üìä TOTAL</div>
            <div style="color:#fff;font-size:1.25em;font-weight:800;">${totalPerfumes} perfumes</div>
          </div>

          <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05)); border: 2px solid rgba(212, 175, 55, 0.4); border-radius: 8px; padding: 12px;">
            <div style="font-size: 0.85em; color: #d4af37; margin-bottom: 6px; font-weight: 600;">üß≠ FUN√á√ïES</div>
            <div style="color:#fff;font-size:1.25em;font-weight:800;">${checked.length}/6 (${cobertura}%)</div>
          </div>
        </div>

        <style>
          @media (max-width: 768px) {
            #dominant-family > div:nth-child(2) { grid-template-columns: 1fr !important; }
          }
        </style>
      `;

      let status = "";
      let advice = "";
      if(checked.length <= 2){
        status = `
          <div style="text-align:center;margin-bottom:12px;">
            <div style="display:inline-block;background: linear-gradient(135deg, rgba(255, 50, 50, 0.3), rgba(200, 0, 0, 0.2)); border: 3px solid #ff3333; border-radius: 12px; padding: 14px 18px; box-shadow: 0 0 26px rgba(255, 50, 50, 0.45);">
              <div style="font-size:1.2em;font-weight:900;color:#ff6666;">üö® FUN√á√ïES CR√çTICAS DESCOBERTAS</div>
            </div>
          </div>
        `;
        advice = `
          Voc√™ n√£o est√° ‚Äúmontando cole√ß√£o‚Äù, voc√™ est√° colecionando ao acaso. 
          Antes de qualquer compra, cubra o b√°sico (principalmente <strong style="color:#d4af37;">calor, trabalho e assinatura</strong>).
        `;
      }else if(checked.length <= 4){
        status = `
          <div style="text-align:center;margin-bottom:12px;">
            <div style="display:inline-block;background: linear-gradient(135deg, rgba(255, 165, 0, 0.3), rgba(255, 140, 0, 0.2)); border: 3px solid #ff9933; border-radius: 12px; padding: 14px 18px; box-shadow: 0 0 22px rgba(255, 165, 0, 0.45);">
              <div style="font-size:1.15em;font-weight:900;color:#ffaa00;">‚ö†Ô∏è COBERTURA PARCIAL</div>
            </div>
          </div>
        `;
        advice = `
          Voc√™ j√° tem uma base, mas ainda compra com risco de redund√¢ncia.
          O pr√≥ximo perfume precisa resolver <strong style="color:#d4af37;">uma fun√ß√£o espec√≠fica</strong> que est√° faltando.
        `;
      }else{
        status = `
          <div style="text-align:center;margin-bottom:12px;">
            <div style="display:inline-block;background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.1)); border: 3px solid rgba(76, 175, 80, 0.55); border-radius: 12px; padding: 14px 18px;">
              <div style="font-size:1.15em;font-weight:900;color:#81c784;">‚úÖ FUN√á√ïES BEM COBERTAS</div>
            </div>
          </div>
        `;
        advice = `
          Boa. Agora o diferencial est√° na qualidade e em fam√≠lias menos representadas (sem repetir a mesma vibe).
        `;
      }

      const missingHtml = missing.length
        ? `<div style="margin-top:10px;">
            <div style="color:#d4af37;font-weight:900;margin-bottom:8px;">O que est√° faltando</div>
            <div style="color:#fff;line-height:1.6;">${missing.join(" ¬∑ ")}</div>
          </div>`
        : `<div style="margin-top:10px;color:#81c784;font-weight:800;">Nada faltando nas 6 fun√ß√µes.</div>`;

      adviceDiv.innerHTML = status + `<div style="font-size:1.05em;line-height:1.75;">${advice}</div>` + missingHtml;

      nextDiv.innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center;align-items:center;margin-top:12px;">
          <button onclick="abrirPerfumistaNoMapa()" style="
            background: linear-gradient(135deg, #d4af37 0%, #f4e5b1 100%);
            color:#1e1e1e;
            border:none;
            padding: 16px 22px;
            border-radius: 12px;
            font-size: 1.02em;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.35);
            transition: all 0.3s ease;
            display:inline-flex;
            align-items:center;
            gap:10px;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 30px rgba(212, 175, 55, 0.55)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(212, 175, 55, 0.35)';">
            <span style="font-size:1.2em;">ü§ñ</span>
            <span>Gerar TOP 3 com I.A. aqui no Mapa</span>
          </button>
        </div>

        <div style="color:#888;font-size:0.85em;margin-top:12px;line-height:1.45;text-align:center;">
          A resposta aparece dentro do iframe (n√£o abre ChatGPT fora).
        </div>

        <div id="perfumista-panel" style="
          display:none;
          margin-top: 18px;
          background: rgba(0,0,0,0.18);
          border: 2px solid rgba(212,175,55,0.28);
          border-radius: 16px;
          padding: 14px;
          text-align:left;
        ">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;">
            <div style="color:#fff;font-weight:900;font-size:1.05em;">O Perfumista ‚Äî TOP 3 dentro do Mapa</div>
            <button onclick="fecharPerfumistaNoMapa()" style="
              background: rgba(255,255,255,0.06);
              color:#f4e5b1;
              border: 2px solid rgba(212,175,55,0.28);
              padding: 8px 12px;
              border-radius: 10px;
              font-weight: 800;
              cursor:pointer;
            ">Fechar</button>
          </div>

          <iframe
            id="perfumista-iframe"
            src="https://vguerise.github.io/operfumista/"
            scrolling="no"
            style="width:100%;border:0;border-radius:12px;background:#111;overflow:hidden;min-height:420px;"
            loading="lazy"
          ></iframe>
        </div>
      `;

      resultDiv.style.display = "block";
      resultDiv.scrollIntoView({ behavior:"smooth", block:"nearest" });
    }
  </script>
</body>
</html>
