<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa da Cole√ß√£o Perfeita ‚Äî MAPA_PAI_V10_20260102_005100</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#1e1e1e 0%,#2d2d2d 100%);
      padding:20px;
      min-height:100vh;
    }
    .container{max-width:1400px;margin:0 auto}
    header{text-align:center;color:white;margin-bottom:40px}
    h1{
      font-size:2.5em;margin-bottom:10px;
      background:linear-gradient(90deg,#d4af37,#f4e5b1);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .subtitle{color:#999;font-size:1.1em}
    .section-title{
      color:white;font-size:1.8em;margin:40px 0 20px 0;text-align:center;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:20px;
      margin-bottom:40px;
    }
    .card{
      background:rgba(255,255,255,0.05);
      border:2px solid rgba(212,175,55,0.3);
      border-radius:15px;
      padding:25px;
      transition:all 0.3s ease;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .card:hover{
      transform:translateY(-5px);
      border-color:#d4af37;
      box-shadow:0 10px 30px rgba(212,175,55,0.3);
    }
    .card::before{
      content:'';
      position:absolute;top:0;left:0;width:100%;height:5px;
      background:linear-gradient(90deg,#d4af37,#f4e5b1);
    }
    .card-title{color:#d4af37;font-size:1.4em;margin-bottom:15px;font-weight:600}
    .card-description{color:#ccc;font-size:0.95em;line-height:1.6;margin-bottom:15px}
    .card-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:15px}
    .tag{
      background:rgba(212,175,55,0.2);
      color:#d4af37;
      padding:5px 12px;
      border-radius:20px;
      font-size:0.85em;
      border:1px solid rgba(212,175,55,0.3);
    }
    .examples{
      background:rgba(212,175,55,0.1);
      padding:12px;
      border-radius:8px;
      margin-top:15px;
    }
    .examples-title{color:#d4af37;font-size:0.9em;font-weight:600;margin-bottom:8px}
    .examples-list{color:#aaa;font-size:0.85em;line-height:1.5}
    .checkbox-container{
      display:flex;align-items:center;gap:10px;margin-top:10px;
      padding:15px;
      background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(212,175,55,0.05));
      border:2px solid rgba(212,175,55,0.4);
      border-radius:8px;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .checkbox-container:hover{
      background:linear-gradient(135deg,rgba(212,175,55,0.25),rgba(212,175,55,0.1));
    }
    .checkbox-container input{transform:scale(1.2);cursor:pointer}
    .checkbox-container label{color:#fff;font-size:1.05em;font-weight:600;cursor:pointer}

    .balance-section{display:flex;justify-content:center;margin-top:30px}
    .balance-card{
      background:rgba(255,255,255,0.05);
      border:2px solid rgba(212,175,55,0.3);
      border-radius:15px;
      padding:40px;
      max-width:900px;
      width:100%;
    }
    .balance-title{color:#d4af37;font-size:1.8em;margin-bottom:10px;text-align:center}
    .balance-description{color:#ccc;text-align:center;margin-bottom:22px;line-height:1.6}
    .context-section{
      margin:20px 0 18px 0;
      padding:18px;
      border-radius:12px;
      background:linear-gradient(135deg,rgba(100,150,255,0.12),rgba(100,150,255,0.04));
      border:2px solid rgba(100,150,255,0.25);
    }
    .context-title{color:#9bc4ff;font-weight:800;margin-bottom:12px;letter-spacing:0.5px}
    textarea.colecao{
      width:100%;
      min-height:140px;
      margin-top:10px;
      background:rgba(0,0,0,0.35);
      color:#fff;
      border:2px solid rgba(212,175,55,0.25);
      border-radius:10px;
      padding:12px;
      font-size:1em;
      line-height:1.5;
      outline:none;
      transition:all 0.25s ease;
      resize:vertical;
    }
    textarea.colecao:focus{border-color:#d4af37;box-shadow:0 0 0 3px rgba(212,175,55,0.15)}
    .helper{color:#9c9c9c;font-size:0.9em;margin-top:8px;line-height:1.5}

    .analyze-btn{
      width:100%;
      padding:15px;
      font-size:1.2em;
      font-weight:700;
      background:linear-gradient(90deg,#d4af37,#f4e5b1);
      color:#1e1e1e;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      margin-top:18px;
    }
    .analyze-btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(212,175,55,0.4)}
    .result-box{
      margin-top:30px;
      background:rgba(212,175,55,0.1);
      border:2px solid rgba(212,175,55,0.25);
      border-radius:12px;
      padding:22px;
    }
    .result-title{color:#d4af37;font-size:1.35em;font-weight:900;margin-bottom:14px;text-align:center}
    .result-content{color:#fff;line-height:1.65}
    .result-advice{color:#ccc;margin-top:12px;line-height:1.7}
    .result-next{margin-top:18px}

    .interactive-note{
      background:rgba(100,150,255,0.1);
      border:2px solid rgba(100,150,255,0.3);
      border-radius:10px;
      padding:20px;
      margin-top:40px;
      text-align:center;
      color:#9bc4ff;
    }

    @media (max-width: 1024px){
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width: 768px){
      h1{font-size:1.85em}
      .grid{grid-template-columns:1fr}
      .balance-card{padding:26px}
    }
  

    /* ==============================
       Cole√ß√£o (Adicionar + Modal)
       ============================== */
    .colecao-add-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .colecao-input{
      flex:1 1 320px;
      min-width:260px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      color:#fff;
      outline:none;
    }
    .colecao-input:focus{border-color:rgba(155,196,255,.55)}
    .mini-btn{
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(155,196,255,.35);
      background:rgba(14,38,78,.55);
      color:#eaf2ff;
      font-weight:800;
      cursor:pointer;
      transition:transform .08s ease, filter .2s ease;
      white-space:nowrap;
    }
    .mini-btn:hover{filter:brightness(1.1)}
    .mini-btn:active{transform:scale(.98)}
    .mini-btn.secondary{
      background:rgba(0,0,0,.20);
      border-color:rgba(255,255,255,.16);
      color:#e8eefc;
      font-weight:700;
    }

    /* Modal */
    .modal{position:fixed;inset:0;display:none;z-index:9999}
    .modal.show{display:block}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .modal-card{
      position:relative;
      width:min(720px, calc(100% - 28px));
      margin:70px auto 0;
      background:rgba(10,18,35,.96);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10)}
    .modal-title{font-weight:900;color:#eaf2ff;letter-spacing:.2px}
    .modal-close{
      width:36px;height:36px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#eaf2ff;
      cursor:pointer;
      font-weight:900;
    }
    .modal-close:hover{filter:brightness(1.1)}
    .modal-body{padding:14px 16px}
    .modal-sub{color:rgba(255,255,255,.72);margin-bottom:10px}
    .colecao-pre{
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 14px;
      color:#fff;
      max-height:320px;
      overflow:auto;
      white-space:pre-wrap;
      line-height:1.5;
    }
    .modal-footer{padding:12px 16px;border-top:1px solid rgba(255,255,255,.10);display:flex;justify-content:flex-end;gap:10px}

/* Anima√ß√µes do popup de loading (mantidas do original) */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes slideUp { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

</style>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
</head>

<body>
  <div class="container">
    <header>
      <h1>MAPA DA COLE√á√ÉO PERFEITA</h1>
      <p class="subtitle">Sem redund√¢ncia. Cada perfume com fun√ß√£o real.</p>
    </header>

    <h2 class="section-title">AS 6 FUN√á√ïES ESSENCIAIS</h2>

    <div class="grid">
      <div class="card">
        <div class="card-title">üåû CALOR</div>
        <div class="card-description">
          Perfume leve, fresco e que n√£o sufoca. Alta temperatura exige baixa densidade.
        </div>
        <div class="card-tags">
          <span class="tag">C√≠trico</span><span class="tag">Aqu√°tico</span><span class="tag">Verde</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ C√≠trico + aqu√°tico<br>‚Ä¢ Verde fresco<br>‚Ä¢ Arom√°tico leve</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="calor" />
          <label for="calor">Tenho um perfume para calor</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚ùÑÔ∏è FRIO</div>
        <div class="card-description">
          Perfume denso, quente e envolvente. Baixa temperatura pede mais corpo e presen√ßa.
        </div>
        <div class="card-tags">
          <span class="tag">√Çmbar</span><span class="tag">Madeira</span><span class="tag">Especiaria</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ √Çmbar + baunilha<br>‚Ä¢ Madeira seca + especiaria<br>‚Ä¢ Oriental denso</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="frio" />
          <label for="frio">Tenho um perfume para frio</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üíº TRABALHO</div>
        <div class="card-description">
          Discreto, profissional, baixo risco. Passa batido at√© ser notado de perto.
        </div>
        <div class="card-tags">
          <span class="tag">Arom√°tico</span><span class="tag">Amadeirado seco</span><span class="tag">Fresco discreto</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ Arom√°tico limpo<br>‚Ä¢ Amadeirado elegante<br>‚Ä¢ Fresco-seco balanceado</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="trabalho" />
          <label for="trabalho">Tenho um perfume para trabalho</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üåô NOITE</div>
        <div class="card-description">
          Marcante e de presen√ßa. Aqui voc√™ pode ousar (desde que fa√ßa sentido pra voc√™).
        </div>
        <div class="card-tags">
          <span class="tag">Doce denso</span><span class="tag">Couro</span><span class="tag">Oriental intenso</span>
        </div>
        <div class="examples">
          <div class="examples-title">Constru√ß√µes ideais:</div>
          <div class="examples-list">‚Ä¢ Doce + especiaria<br>‚Ä¢ Couro + fuma√ßa<br>‚Ä¢ √Çmbar + oud</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="noite" />
          <label for="noite">Tenho um perfume para noite</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">‚úçÔ∏è ASSINATURA</div>
        <div class="card-description">
          Seu perfume identidade. Vers√°til, confort√°vel e voc√™ ama usar.
        </div>
        <div class="card-tags">
          <span class="tag">Pessoal</span><span class="tag">Vers√°til</span><span class="tag">Confort√°vel</span>
        </div>
        <div class="examples">
          <div class="examples-title">Caracter√≠sticas:</div>
          <div class="examples-list">‚Ä¢ Funciona em v√°rias situa√ß√µes<br>‚Ä¢ Voc√™ n√£o cansa dele<br>‚Ä¢ As pessoas te associam a ele</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="assinatura" />
          <label for="assinatura">Tenho meu perfume assinatura</label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üéä OCASI√ïES ESPECIAIS</div>
        <div class="card-description">
          Para casamentos, eventos, festas e momentos memor√°veis.
        </div>
        <div class="card-tags">
          <span class="tag">Festivo</span><span class="tag">Marcante</span><span class="tag">Especial</span>
        </div>
        <div class="examples">
          <div class="examples-title">Ocasi√µes ideais:</div>
          <div class="examples-list">‚Ä¢ Casamentos e formaturas<br>‚Ä¢ Festas e celebra√ß√µes<br>‚Ä¢ Jantares e eventos</div>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="ocasioes" />
          <label for="ocasioes">Tenho perfume para ocasi√µes especiais</label>
        </div>
      </div>
    </div>

    <h2 class="section-title">üéØ DIAGN√ìSTICO + TOP 3 COM I.A.</h2>

    <div class="balance-section">
      <div class="balance-card">
        <div class="balance-title">Cole sua cole√ß√£o (fica salva no seu navegador)</div>
        <div class="balance-description">
          Sem base de dados aqui no mapa. Voc√™ coloca a sua lista, escolhe o contexto, e o Perfumista sugere s√≥ o Top 3 no iframe.
        </div>

        <div class="context-section">
          <div class="context-title">üìç Contexto</div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:22px;">
            <div style="display:flex;flex-direction:column;gap:14px;">
              <div>
                <label style="margin-bottom:10px;display:block;color:#9bc4ff;font-weight:600;">üíº Ambiente de trabalho</label>
                <select id="ambiente" style="width:100%;padding:12px 15px;font-size:1em;background:rgba(0,0,0,0.3);border:2px solid rgba(100,150,255,0.3);border-radius:8px;color:white;cursor:pointer;transition:all 0.3s ease;"
                  onfocus="this.style.borderColor='#9bc4ff'" onblur="this.style.borderColor='rgba(100,150,255,0.3)'">
                  <option value="" selected disabled>Selecione</option>
                  <option value="fechado">Fechado (escrit√≥rio, loja)</option>
                  <option value="aberto">Aberto (obra, rua, campo)</option>
                  <option value="ambos">Ambos</option>
                </select>
              </div>

              <div>
                <label style="margin-bottom:10px;display:block;color:#9bc4ff;font-weight:600;">üí∞ Or√ßamento</label>
                <select id="orcamento" style="width:100%;padding:12px 15px;font-size:1em;background:rgba(0,0,0,0.3);border:2px solid rgba(100,150,255,0.3);border-radius:8px;color:white;cursor:pointer;transition:all 0.3s ease;"
                  onfocus="this.style.borderColor='#9bc4ff'" onblur="this.style.borderColor='rgba(100,150,255,0.3)'">
                  <option value="" selected disabled>Selecione</option>
                  <option value="ate-350">At√© R$ 350</option>
                  <option value="350-1500">R$ 350 - R$ 1.500</option>
                  <option value="1500-2500">R$ 1.500 - R$ 2.500</option>
                  <option value="sem-limite">Sem limite</option>
                </select>
              </div>
            </div>

            <div>
              <label style="margin-bottom:10px;display:block;color:#9bc4ff;font-weight:600;">üå°Ô∏è Clima da sua regi√£o</label>
              <input type="hidden" id="clima" value="temperado" />
              <div style="display:flex;gap:10px;margin-top:10px;">
                <button type="button" onclick="selecionarClima('quente', this)" class="clima-btn"
                  style="flex:1;padding:15px 10px;background:rgba(255,100,100,0.1);border:2px solid rgba(255,100,100,0.3);color:white;border-radius:10px;cursor:pointer;font-size:0.95em;transition:all 0.3s;text-align:center;">
                  <div style="font-size:1.5em;margin-bottom:5px;">‚òÄÔ∏è</div>
                  <div style="font-weight:600;">Quente</div>
                  <div style="font-size:0.75em;color:#888;margin-top:3px;">Norte, Nordeste</div>
                </button>

                <button type="button" onclick="selecionarClima('temperado', this)" class="clima-btn"
                  style="flex:1;padding:15px 10px;background:rgba(212,175,55,0.3);border:2px solid #d4af37;color:white;border-radius:10px;cursor:pointer;font-size:0.95em;transition:all 0.3s;text-align:center;box-shadow:0 0 20px rgba(212,175,55,0.5);">
                  <div style="font-size:1.5em;margin-bottom:5px;">üå§Ô∏è</div>
                  <div style="font-weight:600;">Temperado</div>
                  <div style="font-size:0.75em;color:#888;margin-top:3px;">Sudeste</div>
                </button>

                <button type="button" onclick="selecionarClima('frio', this)" class="clima-btn"
                  style="flex:1;padding:15px 10px;background:rgba(150,200,255,0.1);border:2px solid rgba(150,200,255,0.3);color:white;border-radius:10px;cursor:pointer;font-size:0.95em;transition:all 0.3s;text-align:center;">
                  <div style="font-size:1.5em;margin-bottom:5px;">‚ùÑÔ∏è</div>
                  <div style="font-weight:600;">Frio</div>
                  <div style="font-size:0.75em;color:#888;margin-top:3px;">Sul</div>
                </button>
              </div>
            </div>
          </div>

          
          <div style="margin-top:18px;">
            <label style="display:block;color:#9bc4ff;font-weight:700;margin-bottom:8px;">üßæ Sua cole√ß√£o</label>

            <div class="colecao-add-row">
              <input id="perfumeInput" class="colecao-input" type="text" placeholder="Digite o nome do perfume e clique em Adicionar" autocomplete="off" />
              <button class="mini-btn" type="button" onclick="addPerfume()">Adicionar</button>
              <button class="mini-btn secondary" type="button" onclick="openColecaoModal()">Ver cole√ß√£o completa (<span id="colecaoCount">0</span>)</button>
            </div>

            <div class="helper">
              ‚Ä¢ Isso fica salvo no seu navegador (localStorage).<br>
              ‚Ä¢ Ao adicionar, o nome √© padronizado na exibi√ß√£o (Primeira Letra Mai√∫scula).<br>
              ‚Ä¢ Se voc√™ n√£o preencher, o Perfumista vai trabalhar s√≥ com as 6 fun√ß√µes e o contexto ‚Äî fica pior.
            </div>
          </div>

          <!-- Modal: Cole√ß√£o completa -->
          <div id="colecaoModal" class="modal" aria-hidden="true">
            <div class="modal-backdrop" onclick="closeColecaoModal()"></div>
            <div class="modal-card" role="dialog" aria-modal="true" aria-label="Cole√ß√£o completa">
              <div class="modal-header">
                <div class="modal-title">üìö Cole√ß√£o completa</div>
                <button class="modal-close" type="button" onclick="closeColecaoModal()">‚úï</button>
              </div>
              <div class="modal-body">
                <div class="modal-sub">
                  <span>Total:</span> <strong><span id="colecaoTotalModal">0</span></strong>
                </div>
                <pre id="colecaoList" class="colecao-pre">(vazio)</pre>
              </div>
              <div class="modal-footer">
                <button class="mini-btn secondary" type="button" onclick="closeColecaoModal()">Fechar</button>
              </div>
            </div>
          </div>

        </div>

        <button class="analyze-btn" onclick="analyzeCollection()">MAPEAR COLE√á√ÉO!</button>

        <div id="result" class="result-box" style="display:none;">
          <div class="result-title">üìä RESULTADO DA AN√ÅLISE</div>
          <div id="dominant-family" class="result-content"></div>
          <div id="balance-advice" class="result-advice"></div>
          <div id="next-purchase" class="result-next"></div>
        </div>
      </div>
    </div>

    <div class="interactive-note">
      <h3 style="margin-bottom:15px;">üìã COMO USAR</h3>
      <p style="line-height:1.8;">
        1) Marque as 6 fun√ß√µes que voc√™ j√° cobre<br>
        2) Cole sua lista de perfumes (um por linha)<br>
        3) Clique em ‚ÄúAnalisar‚Äù<br>
        4) Gere o Top 3 no Perfumista dentro do iframe
      </p>
    </div>
  </div>

  <script>

  // FORCE motor URL (repo separado) + cache-buster
  const PERfumista_URL_BASE = "https://vguerise.github.io/operfumista/";
  function setIframeSrcWithBust(){
    const iframe = document.getElementById("perfumista-iframe");
    if(!iframe) return;
    const bust = Date.now();
    iframe.src = PERfumista_URL_BASE + "?v=" + bust;
  }


/* ==============================
   Mapa Pai ‚Äì Cole√ß√£o + Diagn√≥stico ‚Üí Iframe
   Regras:
   - Cole√ß√£o em localStorage (array)
   - Bot√£o "Mapear Cole√ß√£o!" envia payload ao iframe
   - Popup "Analisando..." fica vis√≠vel at√© o iframe sinalizar IA_DONE
============================== */

// ---- LocalStorage keys
const LS_KEYS = {
  colecao: "mcp_colecao_v1",
  clima: "mcp_clima_v1",
  ambiente: "mcp_ambiente_v1",
  orcamento: "mcp_orcamento_v1",
  funcoes: "mcp_funcoes_v1"
};

// ---- Helpers LS
function safeGet(key){
  try { return localStorage.getItem(key); } catch(e){ return null; }
}
function safeSet(key, value){
  try { localStorage.setItem(key, value); } catch(e){}
}

// ---- Title Case (com exce√ß√µes)
function toTitleCaseSmart(str){
  const minor = new Set(["de","da","do","das","dos","e","em","no","na","nos","nas"]);
  const keepUpper = new Set(["EDT","EDP","EDC","EDP.","EDT.","EDC.","PARFUM","INTENSE","ELIXIR"]);
  return String(str || "")
    .trim()
    .replace(/\s+/g, " ")
    .split(" ")
    .map((w, idx) => {
      const raw = w.replace(/\u00AD/g,""); // remove soft hyphen
      const up = raw.toUpperCase();
      if(keepUpper.has(up)) return up;
      const low = raw.toLowerCase();
      if(idx>0 && minor.has(low)) return low;
      return low.charAt(0).toUpperCase() + low.slice(1);
    })
    .join(" ");
}

// ---- Cole√ß√£o: load/save
function loadCollection(){
  const raw = safeGet(LS_KEYS.colecao);
  if(!raw) return [];
  try{
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function saveCollection(arr){
  safeSet(LS_KEYS.colecao, JSON.stringify(arr || []));
}

// ---- UI: contador
function updateColecaoCount(){
  const countEl = document.getElementById("colecaoCount");
  const arr = loadCollection();
  if(countEl) countEl.textContent = String(arr.length);
}

// ---- Modal (popup da cole√ß√£o)
function openColecaoModal(){
  const modal = document.getElementById("colecaoModal");
  const list = document.getElementById("colecaoModalList");
  const empty = document.getElementById("colecaoModalEmpty");
  if(!modal || !list || !empty) return;

  const arr = loadCollection();
  list.innerHTML = "";
  if(!arr.length){
    empty.style.display = "block";
  }else{
    empty.style.display = "none";
    arr.forEach(p=>{
      const li = document.createElement("li");
      li.textContent = p;
      list.appendChild(li);
    });
  }

  modal.classList.add("show");
  modal.setAttribute("aria-hidden", "false");
}
function closeColecaoModal(){
  const modal = document.getElementById("colecaoModal");
  if(!modal) return;
  modal.classList.remove("show");
  modal.setAttribute("aria-hidden", "true");
}

// ---- Adicionar/Remover
function addPerfume(){
  const input = document.getElementById("perfumeInput");
  if(!input) return;

  const raw = input.value.trim();
  if(!raw) return;

  const formatted = toTitleCaseSmart(raw);
  const arr = loadCollection();

  // evita duplicado exato
  if(arr.some(x => x.toLowerCase() === formatted.toLowerCase())){
    input.value = "";
    updateColecaoCount();
    return;
  }

  arr.push(formatted);
  saveCollection(arr);
  input.value = "";
  updateColecaoCount();
}
function clearCollection(){
  saveCollection([]);
  updateColecaoCount();
}

// ---- Clima (bot√µes)
function selecionarClima(clima, btn){
  const select = document.getElementById("clima");
  if(select) select.value = clima;
  safeSet(LS_KEYS.clima, clima);

  const btns = document.querySelectorAll(".clima-btn");
  btns.forEach(b=>{
    b.classList.remove("active");
    b.style.boxShadow = "none";
  });

  if(btn){
    btn.classList.add("active");
    btn.style.boxShadow = "0 0 0 2px rgba(212,175,55,0.45) inset";
  }
}

// ---- Fun√ß√µes (checkboxes)
function getCheckedFuncoes(){
  const boxes = Array.from(document.querySelectorAll('input[name="function"]:checked'));
  const all = Array.from(document.querySelectorAll('input[name="function"]'));
  const checked = boxes.map(b=>b.value);
  const missing = all.map(b=>b.value).filter(v=>!checked.includes(v));
  return { checked, missing, total: all.length };
}

// ---- Labels
function calcLevel(total){
  if(total <= 4) return { label:"INICIANTE", emoji:"üå±", advice:"Foco em versatilidade e preencher lacunas com seguran√ßa." };
  if(total <= 8) return { label:"INTERMEDI√ÅRIO", emoji:"üß≠", advice:"Voc√™ j√° tem base; agora √© hora de equilibrar fun√ß√µes e estilos." };
  return { label:"AVAN√áADO", emoji:"üèÜ", advice:"Hora de refinar: escolhas cir√∫rgicas para cobrir lacunas espec√≠ficas." };
}
function labelOrcamento(v){
  const map = {
    "ate-300": "At√© R$ 300",
    "300-500": "R$ 300 - R$ 500",
    "500-1000": "R$ 500 - R$ 1.000",
    "350-1500": "R$ 350 - R$ 1.500",
    "1500-2500": "R$ 1.500 - R$ 2.500",
    "sem-limite": "Sem limite"
  };
  return map[v] || "N√£o informado";
}
function labelAmbiente(v){
  const map = {
    "fechado": "Fechado (escrit√≥rio/loja)",
    "aberto": "Aberto (rua/obra/campo)",
    "ambos": "Ambos"
  };
  return map[v] || "N√£o informado";
}

// ---- Popup "Analisando..."
let perfumistaProgressTimer = null;
function mostrarLoadingPerfumista(){
  const existing = document.getElementById("loading-overlay");
  if(existing) return;

  const overlay = document.createElement("div");
  overlay.id = "loading-overlay";
  overlay.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;

  const box = document.createElement("div");
  box.style.cssText = `
    width: min(520px, 92vw);
    background: rgba(30,30,30,0.96);
    border: 2px solid rgba(212,175,55,0.7);
    border-radius: 14px;
    padding: 18px 18px 16px;
    color: #fff;
    text-align: center;
    box-shadow: 0 12px 40px rgba(0,0,0,0.45);
  `;

  box.innerHTML = `
    <div style="font-size:1.15em;font-weight:800;color:#d4af37;margin-bottom:10px;">üß† Analisando sua cole√ß√£o...</div>
    <div id="loading-msg" style="color:#cfcfcf;font-size:0.95em;line-height:1.35;">
      Estou cruzando seu clima, or√ßamento e lacunas para gerar o Top 3.
    </div>
    <div style="margin-top:14px;">
      <div style="width:44px;height:44px;border-radius:50%;border:4px solid rgba(212,175,55,0.25);border-top-color:#d4af37;margin:0 auto;animation:spin 0.9s linear infinite;"></div>
    </div>
    <div style="margin-top:12px;color:#9e9e9e;font-size:0.85em;">N√£o feche esta janela.</div>
  `;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  const msgs = [
    "Estou cruzando seu clima, or√ßamento e lacunas para gerar o Top 3.",
    "Ajustando recomenda√ß√µes para seu ambiente de trabalho‚Ä¶",
    "Priorizando fam√≠lias menos representadas na sua cole√ß√£o‚Ä¶",
    "Finalizando as 3 melhores op√ß√µes para voc√™‚Ä¶"
  ];
  let i = 0;
  perfumistaProgressTimer = setInterval(()=>{
    const el = document.getElementById("loading-msg");
    if(el){
      i = (i+1) % msgs.length;
      el.textContent = msgs[i];
    }
  }, 1200);
}
function esconderLoadingPerfumista(){
  const overlay = document.getElementById("loading-overlay");
  if(perfumistaProgressTimer){
    clearInterval(perfumistaProgressTimer);
    perfumistaProgressTimer = null;
  }
  if(overlay) overlay.remove();
}

// ---- Envio pro iframe
function ensureIframeVisible(){
  const panel = document.getElementById("perfumista-panel");
  if(panel) panel.style.display = "block";
  const iframe = document.getElementById("perfumista-iframe");
  if(iframe) iframe.scrollIntoView({behavior:"smooth", block:"start"});
}


function sendToIframe(payload){
  const iframe = document.getElementById("perfumista-iframe");
  if(!iframe || !iframe.contentWindow){
    console.warn("Iframe n√£o encontrado ou n√£o carregado. Verifique o caminho do motor (iframe).");
    return;
  }
  iframe.contentWindow.postMessage({ type:"MAPA_DADOS", payload }, "*");
}

// ---- Mapear Cole√ß√£o!
async function analyzeCollection(){
  const clima = (document.getElementById("clima")?.value || "temperado").trim();
  const ambiente = (document.getElementById("ambiente")?.value || "").trim();
  const orcamento = (document.getElementById("orcamento")?.value || "").trim();

  safeSet(LS_KEYS.clima, clima);
  if(ambiente) safeSet(LS_KEYS.ambiente, ambiente);
  if(orcamento) safeSet(LS_KEYS.orcamento, orcamento);

  const colecaoArr = loadCollection();
  const totalPerfumes = colecaoArr.length;

  const { checked, missing, total: totalFuncoes } = getCheckedFuncoes();
  const level = calcLevel(totalPerfumes);
  const cobertura = totalFuncoes ? Math.round((checked.length / totalFuncoes) * 100) : 0;

  // Diagn√≥stico para o agente (iframe)
  let diagnostico = "";
  diagnostico += "Ol√°! Acabei de fazer meu diagn√≥stico de cole√ß√£o de perfumes e preciso de ajuda.\n\n";
  diagnostico += "üìä MEU PERFIL:\n";
  diagnostico += "‚Ä¢ Total de perfumes: " + totalPerfumes + "\n";
  diagnostico += "‚Ä¢ N√≠vel: " + level.label + "\n";
  diagnostico += "‚Ä¢ Clima: " + clima + "\n";
  diagnostico += "‚Ä¢ Or√ßamento: " + labelOrcamento(orcamento) + "\n";
  diagnostico += "‚Ä¢ Ambiente de trabalho: " + labelAmbiente(ambiente) + "\n\n";

  diagnostico += "üßæ MINHA COLE√á√ÉO (um por linha):\n";
  if(colecaoArr.length){
    diagnostico += colecaoArr.join("\n") + "\n\n";
  }else{
    diagnostico += "(n√£o informada)\n\n";
  }

  diagnostico += "üß≠ FUN√á√ïES COBERTAS NO MAPA:\n";
  diagnostico += "‚Ä¢ Cobertas: " + (checked.length ? checked.join(", ") : "Nenhuma") + "\n";
  diagnostico += "‚Ä¢ Descobertas: " + (missing.length ? missing.join(", ") : "Nenhuma") + "\n\n";

  diagnostico += "üéØ O QUE PRECISO:\n";
  diagnostico += "Me d√™ APENAS 3 sugest√µes (Top 3) dispon√≠veis no Brasil.\n";
  diagnostico += "Priorize fam√≠lias/estilos menos representados na minha cole√ß√£o e que fa√ßam sentido para clima, or√ßamento e ambiente.\n";
  diagnostico += "Evite redund√¢ncias √≥bvias com o que eu j√° tenho.";

  // Atualiza an√°lise no mapa pai (sem recomenda√ß√µes)
  const resultDiv = document.getElementById("result");
  const dominantDiv = document.getElementById("dominant-family");
  const adviceDiv = document.getElementById("balance-advice");
  const nextDiv = document.getElementById("next-purchase");

  const climaLabel = clima === "quente" ? "üå°Ô∏è Clima quente" : clima === "frio" ? "‚ùÑÔ∏è Clima frio" : "üå§Ô∏è Clima temperado";

  if(dominantDiv){
    dominantDiv.innerHTML = `
      <div style="background: rgba(212,175,55,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #d4af37;">
        <div style="font-size: 1.25em; margin-bottom: 8px;">${level.emoji} <strong>SEU N√çVEL: ${level.label}</strong></div>
        <div style="color:#ccc; font-size: 0.95em;">${level.advice}</div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:14px;">
        <div style="background: linear-gradient(135deg, rgba(100, 150, 255, 0.15), rgba(100, 150, 255, 0.05)); border: 2px solid rgba(100, 150, 255, 0.4); border-radius: 8px; padding: 12px;">
          <div style="font-size: 0.85em; color: #9bc4ff; margin-bottom: 6px; font-weight: 600;">üå°Ô∏è CLIMA</div>
          <div style="color:#fff;font-size:0.98em;">${climaLabel}</div>
        </div>

        <div style="background: linear-gradient(135deg, rgba(255, 180, 80, 0.15), rgba(255, 180, 80, 0.05)); border: 2px solid rgba(255, 180, 80, 0.4); border-radius: 8px; padding: 12px;">
          <div style="font-size: 0.85em; color: #ffcf8a; margin-bottom: 6px; font-weight: 600;">üíº AMBIENTE</div>
          <div style="color:#fff;font-size:0.98em;">${labelAmbiente(ambiente)}</div>
        </div>
      </div>

      <div style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 12px;">
        <div style="font-size: 0.85em; color: #d4af37; margin-bottom: 6px; font-weight: 700;">üì¶ COLE√á√ÉO</div>
        <div style="color:#fff;">${totalPerfumes} perfume(s)</div>
      </div>
    `;
  }

  if(adviceDiv){
    adviceDiv.innerHTML = `
      <div style="background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; padding: 12px;">
        <div style="font-size: 0.85em; color: #d4af37; margin-bottom: 6px; font-weight: 700;">üß≠ COBERTURA DE FUN√á√ïES</div>
        <div style="color:#fff; margin-bottom: 6px;"><strong>${cobertura}%</strong> do mapa coberto</div>
        <div style="color:#cfcfcf; font-size:0.92em; line-height:1.35;">
          <strong>Cobertas:</strong> ${checked.length ? checked.join(", ") : "Nenhuma"}<br/>
          <strong>Descobertas:</strong> ${missing.length ? missing.join(", ") : "Nenhuma"}
        </div>
      </div>
    `;
  }

  if(nextDiv){
    nextDiv.innerHTML = `
      <div style="background: rgba(212,175,55,0.12); border: 1px solid rgba(212,175,55,0.35); border-radius: 8px; padding: 12px;">
        <div style="font-size: 0.85em; color: #d4af37; margin-bottom: 6px; font-weight: 800;">‚û°Ô∏è PR√ìXIMO PASSO</div>
        <div style="color:#fff; font-size:0.95em; line-height:1.35;">
          Clique em <strong>Mapear Cole√ß√£o!</strong> para receber o <strong>Top 3</strong> no painel abaixo (I.A.).
        </div>
      </div>
    `;
  }

  if(resultDiv) resultDiv.style.display = "block";

  setIframeSrcWithBust();
  // Abre o painel do iframe, resolve caminho, mostra popup e envia
  
  ensureIframeVisible();
  mostrarLoadingPerfumista();
  sendToIframe(diagnostico);
}

// ---- Eventos globais
window.addEventListener("message", (e)=>{
  if(!e.data) return;
  if(e.data.type === "IA_DONE"){
    esconderLoadingPerfumista();
  }
});

// ---- Init
(function init(){
  // Cole√ß√£o
  updateColecaoCount();
  const input = document.getElementById("perfumeInput");
  if(input){
    input.addEventListener("keydown", (ev)=>{
      if(ev.key === "Enter"){
        ev.preventDefault();
        addPerfume();
      }
    });
  }

  // Clima salvo
  const savedClima = safeGet(LS_KEYS.clima) || "temperado";
  const select = document.getElementById("clima");
  if(select) select.value = savedClima;
  const btns = document.querySelectorAll(".clima-btn");
  if(btns && btns.length){
    const btnMap = { quente: btns[0], temperado: btns[1], frio: btns[2] };
    selecionarClima(savedClima, btnMap[savedClima] || btns[1]);
  }

  // Ambiente/or√ßamento salvos
  const amb = safeGet(LS_KEYS.ambiente);
  if(amb && document.getElementById("ambiente")) document.getElementById("ambiente").value = amb;

  const orc = safeGet(LS_KEYS.orcamento);
  if(orc && document.getElementById("orcamento")) document.getElementById("orcamento").value = orc;

  // Fechar modal clicando fora
  const m = document.getElementById("colecaoModal");
  if(m){
    m.addEventListener("click", (ev)=>{
      if(ev.target === m) closeColecaoModal();
    });
  }

  // Se o iframe falhar (404 etc.), n√£o deixa o popup preso
  const ifr = document.getElementById("perfumista-iframe");
  if(ifr){
    ifr.addEventListener("error", ()=>{
      console.warn("Falha ao carregar o iframe (motor). Verifique o caminho.");
      esconderLoadingPerfumista();
      const nextDiv = document.getElementById("next-purchase");
      if(nextDiv){
        nextDiv.innerHTML = `
          <div style="background: rgba(255,80,80,0.10); border: 1px solid rgba(255,120,120,0.45); border-radius: 8px; padding: 12px;">
            <div style="font-size: 0.85em; color: #ffb3b3; margin-bottom: 6px; font-weight: 900;">‚ö†Ô∏è MOTOR (IFRAME) N√ÉO CARREGOU</div>
            <div style="color:#fff; font-size:0.95em; line-height:1.35;">
              O caminho do iframe est√° retornando <strong>404</strong>. Crie a pasta <strong>iframe/</strong> com um <strong>index.html</strong>
              (o motor), ou ajuste o caminho no c√≥digo.
            </div>
          </div>
        `;
      }
    });
  }

  // Garante que os bot√µes funcionem mesmo se o HTML original n√£o tiver onclick
  const btnAdd = document.getElementById("btnAddPerfume");
  if(btnAdd) btnAdd.addEventListener("click", addPerfume);

  const btnView = document.getElementById("btnViewColecao");
  if(btnView) btnView.addEventListener("click", openColecaoModal);

  const btnMapear = document.getElementById("btnMapearColecao");
  if(btnMapear) btnMapear.addEventListener("click", analyzeCollection);
  // vers√£o
  console.log("‚úÖ MAPA_PAI_V10_20260102_005100 carregado");
  // Pr√©-carrega o motor
  setIframeSrcWithBust();
})();

</script>

<!-- ==============================
     PAINEL DO PERFUMISTA (IFRAME)
     ============================== -->
<section id="perfumista-panel" style="display:none; margin-top: 24px;">
  <div style="border:2px solid rgba(212,175,55,0.65); border-radius:14px; overflow:hidden; background: rgba(20,20,20,0.6);">
    <div style="padding:12px 14px; background: linear-gradient(180deg, rgba(90,85,70,0.95), rgba(59,56,47,0.95)); border-bottom:1px solid rgba(212,175,55,0.35);">
      <div style="color:#d4af37; font-weight:900; letter-spacing:0.3px;">üß† Motor do Mapa (I.A.)</div>
      <div style="color:#c8c8c8; font-size:0.92em; margin-top:4px;">O Top 3 aparece aqui embaixo.</div>
    </div>
    <iframe
      id="perfumista-iframe"
      title="Perfumista (Motor do Mapa)"
      src="about:blank"
      style="width:100%; height: 560px; border:0; display:block; background:#2f2f2f;"
      loading="lazy"
      referrerpolicy="no-referrer"
      allow="clipboard-read; clipboard-write"
    ></iframe>
  </div>
</section>

</body>
</html>
